<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Testing Platform</title>
    <style>
        #publicContent {
            text-align: center;
            padding: 50px;
            font-family: Arial, sans-serif;
        }
        
        #testingPlatform {
            display: none;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        
        #secretTarget {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            opacity: 0.3;
            background: #ff4444;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10000;
            transition: opacity 0.3s;
            font-size: 18px;
        }
        
        #secretTarget:hover {
            opacity: 0.7;
        }
        
        #passwordModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            min-width: 300px;
        }
        
        .test-button {
            padding: 12px 24px;
            margin: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .print-button {
            background: #28a745;
        }
        
        .chatgpt-button {
            background: #10A37F;
        }

        .web-chatgpt-button {
            background: #FF6B35;
        }
        
        .results {
            background: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }

        .results.highlight {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .ai-toggle {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .toggle-option {
            padding: 12px 30px;
            margin: 0 10px;
            border: 2px solid #007bff;
            border-radius: 25px;
            cursor: pointer;
            background: white;
            color: #007bff;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .toggle-option.active {
            background: #007bff;
            color: white;
        }

        .toggle-option:hover {
            transform: scale(1.05);
        }

        .toggle-option.gemini.active {
            background: #8B5CF6;
            border-color: #8B5CF6;
        }

        .toggle-option.chatgpt.active {
            background: #10A37F;
            border-color: #10A37F;
        }

        #cookieResult, #accessibilityResult {
            border: 1px solid #ccc;
            padding: 12px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            min-height: 100px;
            line-height: 1.5;
        }

        #chatgptResult {
            border: 1px solid #10A37F;
            padding: 20px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: Arial, sans-serif;
            background-color: #f0f9f4;
            min-height: 150px;
            line-height: 1.6;
            border-radius: 8px;
            resize: vertical;
            overflow: auto;
            max-height: none;
            transition: all 0.3s ease;
        }

        #chatgptResult.expanded {
            min-height: 300px;
            background: #e8f5e8;
        }

        #cookieResult.fail, #accessibilityResult.fail, #chatgptResult.fail {
            border-color: red;
            color: red;
        }

        #cookieResult.pass, #accessibilityResult.pass, #chatgptResult.pass {
            border-color: green;
            color: green;
        }

        .print-report-container {
            border: 3px solid red !important;
            padding: 20px;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
        }

        #websiteInput {
            width: 70%; 
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        #stateSelect {
            width: 200px;
            padding: 12px;
            margin: 10px;
            border: 2px solid #007bff;
            border-radius: 5px;
            font-size: 16px;
            background: white;
        }

        #chatgptQuestion {
            width: 90%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #10A37F;
            border-radius: 8px;
            font-size: 16px;
            font-family: Arial, sans-serif;
            resize: vertical;
            min-height: 120px;
            max-height: 200px;
        }

        .chatgpt-response-container {
            min-height: 200px;
            max-height: none;
            resize: vertical;
            overflow: auto;
        }

        .word-count {
            text-align: right;
            font-size: 12px;
            color: #666;
            margin-top: -5px;
            margin-bottom: 10px;
        }

        .current-ai {
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            background: linear-gradient(45deg, #007bff, #8B5CF6);
            color: white;
            border-radius: 5px;
            display: none;
        }

        .loading {
            color: #007bff;
            font-style: italic;
        }

        .section-title {
            background: linear-gradient(45deg, #10A37F, #8B5CF6);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 25px 0 15px 0;
            text-align: center;
        }

        .state-compliance {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 25px 0 15px 0;
            text-align: center;
        }

        .form-group {
            margin: 15px 0;
            text-align: center;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        html {
            scroll-behavior: smooth;
        }

        .scroll-target {
            scroll-margin-top: 20px;
        }

        .demo-notice {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #155724;
        }

        .api-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .api-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .api-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .api-status.testing {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }
        
        .api-status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <button id="secretTarget" title="Click me 7 times">üéØ</button>

    <div id="passwordModal">
        <div class="modal-content">
            <h3>üîí Enter Password</h3>
            <input type="password" id="passwordInput" placeholder="Enter password" style="
                padding: 10px;
                margin: 10px 0;
                width: 200px;
                font-size: 16px;
                border: 2px solid #ddd;
                border-radius: 5px;
            ">
            <br>
            <button onclick="checkPassword()" style="
                padding: 10px 20px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 10px;
            ">Login</button>
            <p id="passwordError" style="color: red; display: none; margin-top: 10px;">Incorrect password</p>
        </div>
    </div>

    <div id="publicContent">
        <h1>Welcome to Our Website</h1>
        <p>This is a public website. Nothing to see here for regular visitors.</p>
    </div>

    <div id="testingPlatform">
        <h1>üõ°Ô∏è Your Private Testing Platform</h1>
        <p>Welcome back! Ready to run some tests?</p>
        
        <div class="demo-notice">
            <strong>‚úÖ Live Mode:</strong> Connected to AI services via secure Vercel API endpoints!
        </div>

        <div id="apiStatus" class="api-status testing">
            üîÑ Testing API connection...
        </div>
        
        <div class="state-compliance">
            <h2>üèõÔ∏è State Compliance Testing</h2>
        </div>

        <div class="form-group">
            <label for="stateSelect">Select State for Compliance Analysis:</label>
            <select id="stateSelect">
                <option value="">-- Select a State --</option>
                <option value="california">California</option>
                <option value="newyork">New York</option>
                <option value="florida">Florida</option>
                <option value="texas">Texas</option>
                <option value="georgia">Georgia</option>
                <option value="northcarolina">North Carolina</option>
                <option value="southcarolina">South Carolina</option>
                <option value="utah">Utah</option>
                <option value="virginia">Virginia</option>
                <option value="alabama">Alabama</option>
                <option value="alaska">Alaska</option>
                <option value="arizona">Arizona</option>
                <option value="arkansas">Arkansas</option>
                <option value="colorado">Colorado</option>
                <option value="connecticut">Connecticut</option>
                <option value="delaware">Delaware</option>
                <option value="hawaii">Hawaii</option>
                <option value="idaho">Idaho</option>
                <option value="illinois">Illinois</option>
                <option value="indiana">Indiana</option>
                <option value="iowa">Iowa</option>
                <option value="kansas">Kansas</option>
                <option value="kentucky">Kentucky</option>
                <option value="louisiana">Louisiana</option>
                <option value="maine">Maine</option>
                <option value="maryland">Maryland</option>
                <option value="massachusetts">Massachusetts</option>
                <option value="michigan">Michigan</option>
                <option value="minnesota">Minnesota</option>
                <option value="mississippi">Mississippi</option>
                <option value="missouri">Missouri</option>
                <option value="montana">Montana</option>
                <option value="nebraska">Nebraska</option>
                <option value="nevada">Nevada</option>
                <option value="newhampshire">New Hampshire</option>
                <option value="newjersey">New Jersey</option>
                <option value="newmexico">New Mexico</option>
                <option value="ohio">Ohio</option>
                <option value="oklahoma">Oklahoma</option>
                <option value="oregon">Oregon</option>
                <option value="pennsylvania">Pennsylvania</option>
                <option value="rhodeisland">Rhode Island</option>
                <option value="tennessee">Tennessee</option>
                <option value="vermont">Vermont</option>
                <option value="washington">Washington</option>
                <option value="westvirginia">West Virginia</option>
                <option value="wisconsin">Wisconsin</option>
                <option value="wyoming">Wyoming</option>
            </select>
        </div>
        
        <div class="ai-toggle">
            <div class="toggle-option gemini active" onclick="selectAI('gemini')">
                üîÆ Gemini AI
            </div>
            <div class="toggle-option chatgpt" onclick="selectAI('chatgpt')">
                ü§ñ ChatGPT
            </div>
        </div>

        <div class="current-ai" id="currentAI">
            Currently using: <span id="aiName">Gemini AI</span>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <input type="text" id="websiteInput" placeholder="https://www.example.com" value="https://www.thewebswan.com">
        </div>
        
        <div class="button-group">
            <button class="test-button" id="testCookieBtn">üç™ Test Cookie Compliance</button>
            <button class="test-button" id="testAccessibilityBtn">üîç Test Accessibility</button>
            <button class="test-button print-button" onclick="generateReport()">üìÑ Generate Report</button>
        </div>
        
        <div class="results scroll-target" id="cookieResultContainer">
            <h3>Cookie Compliance Results</h3>
            <div id="cookieResult">Select a state and run the cookie test to see results here...</div>
        </div>
        
        <div class="results scroll-target" id="accessibilityResultContainer">
            <h3>Accessibility Results</h3>
            <div id="accessibilityResult">Select a state and run the accessibility test to see results here...</div>
        </div>

        <div class="section-title">
            <h2>üí¨ AI Assistant - Ask Me Anything</h2>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <textarea 
                id="chatgptQuestion" 
                placeholder="Type your question here... (up to 300 words)"
                maxlength="1500"
            ></textarea>
            <div class="word-count">
                <span id="wordCount">0</span>/300 words
                <span id="charCount">0</span>/1500 characters
            </div>
            <div class="button-group">
                <button class="test-button chatgpt-button" onclick="askAI()">
                    üöÄ Ask AI Assistant
                </button>
                <button class="test-button web-chatgpt-button" onclick="window.open('https://chat.openai.com/', '_blank')">
                    üåê Web ChatGPT
                </button>
                <button class="test-button print-button" onclick="generateAIReport()">
                    üìÑ Print Response
                </button>
            </div>
        </div>

        <div class="results scroll-target" id="chatgptResultContainer">
            <h3>AI Assistant Response <small>(Expandable - Up to 1000 words)</small></h3>
            <div id="chatgptResult" class="chatgpt-response-container">Ask a question to see AI response here...</div>
        </div>

        <div class="results" id="setupInstructions" style="display: none;">
            <h3>üö® API Setup Required</h3>
            <div id="setupContent"></div>
        </div>
    </div>

    <script>
        const stateLaws = {
            california: { 
                cookie: "CCPA/CPRA - California Consumer Privacy Act", 
                accessibility: "Unruh Civil Rights Act + WCAG 2.1 AA" 
            },
            newyork: { 
                cookie: "NY SHIELD Act + Proposed Privacy Law", 
                accessibility: "New York Human Rights Law + WCAG 2.1" 
            },
            florida: { 
                cookie: "Florida Information Protection Act", 
                accessibility: "Florida Civil Rights Act" 
            },
            texas: { 
                cookie: "Texas Identity Theft Enforcement", 
                accessibility: "Texas Human Resources Code" 
            },
            georgia: { 
                cookie: "Georgia Personal Identity Protection", 
                accessibility: "Georgia Equal Access to Services" 
            },
            northcarolina: { 
                cookie: "NC Identity Theft Protection Act", 
                accessibility: "NC Persons with Disabilities Protection" 
            },
            southcarolina: { 
                cookie: "SC Insurance Data Security Act", 
                accessibility: "SC Human Affairs Law" 
            },
            utah: { 
                cookie: "Utah Consumer Privacy Act", 
                accessibility: "Utah Antidiscrimination Act" 
            },
            virginia: { 
                cookie: "VCDPA - Virginia Consumer Data Protection Act", 
                accessibility: "Virginia Human Rights Act" 
            },
            colorado: { cookie: "CPA - Colorado Privacy Act", accessibility: "Colorado Anti-Discrimination Act" },
            connecticut: { cookie: "CTDPA - Connecticut Data Privacy Act", accessibility: "Connecticut Human Rights Law" },
            illinois: { cookie: "BIPA - Biometric Information Privacy Act", accessibility: "Illinois Human Rights Act" },
            nevada: { cookie: "Nevada Privacy Law", accessibility: "Nevada Equal Rights Commission" },
            washington: { cookie: "Washington My Health My Data Act", accessibility: "Washington Law Against Discrimination" }
        };

        // API Configuration
        const API_CONFIG = {
            baseURL: 'https://access-coo-ws.vercel.app',
            endpoints: {
                gemini: '/api/gemini',
                chatgpt: '/api/chatgpt',
                test: '/api/test'
            }
        };

        let currentAI = 'gemini';
        let apiConnected = false;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            checkAPIConnection();
            selectAI('gemini');
        });

        // Improved API connection test
        async function checkAPIConnection() {
            const statusElement = document.getElementById('apiStatus');
            
            try {
                statusElement.innerHTML = 'üîÑ Testing API connection to Vercel...';
                statusElement.className = 'api-status testing';
                
                // Test multiple endpoints to see what's available
                const endpointsToTest = ['/api/gemini', '/api/chatgpt', '/api/test'];
                let availableEndpoints = [];
                
                for (const endpoint of endpointsToTest) {
                    try {
                        // Using a simple OPTIONS or HEAD request is often better for a quick status check, 
                        // but POST with a test payload is used here to match the intended API design.
                        const response = await fetch(`${API_CONFIG.baseURL}${endpoint}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            // Sending a small payload to check for a functional response
                            body: JSON.stringify({ test: true, prompt: 'ping' }) 
                        });
                        
                        // Check if the server responded (even if it's an API Key error, it means the route exists)
                        if (response.status === 200 || response.status === 500) { 
                            availableEndpoints.push(endpoint);
                        }
                    } catch (e) {
                        // Endpoint not available, continue testing others
                    }
                }
                
                if (availableEndpoints.length > 0) {
                    apiConnected = true;
                    statusElement.innerHTML = `‚úÖ API Connected! Available routes detected: ${availableEndpoints.join(', ')}`;
                    statusElement.className = 'api-status connected';
                    document.getElementById('setupInstructions').style.display = 'none';
                } else {
                    // No endpoints found, show setup instructions
                    apiConnected = false;
                    statusElement.innerHTML = '‚ö†Ô∏è API Routes Not Found';
                    statusElement.className = 'api-status warning';
                    showSetupInstructions();
                }
                
            } catch (error) {
                apiConnected = false;
                statusElement.innerHTML = `‚ùå Connection Failed: Check Vercel URL or network.`;
                statusElement.className = 'api-status error';
                showSetupInstructions();
            }
        }

        // Show setup instructions when APIs are missing
        function showSetupInstructions() {
            const setupDiv = document.getElementById('setupInstructions');
            const setupContent = document.getElementById('setupContent');
            
            setupContent.innerHTML = `
                <p><strong>To fix this, you need to create and deploy your backend API files in your Vercel project:</strong></p>
                
                <h4>1. Create /api/gemini.js: (Handles Gemini AI)</h4>
                <pre><code>export default async function handler(req, res) {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    
    if (req.method === 'OPTIONS') return res.status(200).end();
    if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
    
    try {
        const { prompt } = req.body;
        if (!process.env.GEMINI_API_KEY) throw new Error('GEMINI_API_KEY not configured');
        
        const response = await fetch(\`https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=\${process.env.GEMINI_API_KEY}\`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        
        const data = await response.json();
        // Check for 'candidates' property to handle safety blocks or errors
        if (data.candidates && data.candidates.length > 0 && data.candidates[0].content) {
            const result = data.candidates[0].content.parts[0].text;
            res.status(200).json({ response: result, message: 'Success' });
        } else if (data.error) {
            throw new Error(data.error.message);
        } else {
            // Handle cases where the response is empty or blocked
            const blockReason = data.candidates && data.candidates[0].finishReason;
            const safetyRatings = data.candidates && JSON.stringify(data.candidates[0].safetyRatings);
            throw new Error(\`AI response was blocked. Reason: \${blockReason || 'Unknown'}. Safety: \${safetyRatings || 'N/A'}\`);
        }
    } catch (error) {
        res.status(500).json({ error: \`Gemini API Error: \${error.message}\` });
    }
}</code></pre>
                
                <h4>2. Create /api/chatgpt.js: (Handles ChatGPT AI)</h4>
                <pre><code>export default async function handler(req, res) {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    
    if (req.method === 'OPTIONS') return res.status(200).end();
    if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
    
    try {
        const { prompt } = req.body;
        if (!process.env.OPENAI_API_KEY) throw new Error('OPENAI_API_KEY not configured');
        
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': \`Bearer \${process.env.OPENAI_API_KEY}\`
            },
            body: JSON.stringify({
                model: 'gpt-3.5-turbo',
                messages: [{ role: 'user', content: prompt }],
                max_tokens: 1000
            })
        });
        
        const data = await response.json();
        if (data.choices && data.choices.length > 0) {
            const result = data.choices[0].message.content;
            res.status(200).json({ response: result, message: 'Success' });
        } else if (data.error) {
            throw new Error(data.error.message);
        } else {
            throw new Error('No valid response or choices from OpenAI API.');
        }
    } catch (error) {
        res.status(500).json({ error: \`ChatGPT API Error: \${error.message}\` });
    }
}</code></pre>
                
                <h4>3. Set Environment Variables in Vercel:</h4>
                <ul>
                    <li><code>GEMINI_API_KEY</code> = your_gemini_api_key</li>
                    <li><code>OPENAI_API_KEY</code> = your_openai_api_key</li>
                </ul>
                
                <p><strong>Steps:</strong></p>
                <ol>
                    <li>Create an <code>/api</code> folder in your GitHub repository</li>
                    <li>Add the two API files above (<code>gemini.js</code> and <code>chatgpt.js</code>)</li>
                    <li>Set environment variables in Vercel dashboard</li>
                    <li>Vercel will auto-deploy when you push to GitHub</li>
                </ol>
            `;
            
            setupDiv.style.display = 'block';
        }

        function smoothScrollToElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('highlight');
                element.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center'
                });
                setTimeout(() => {
                    element.classList.remove('highlight');
                }, 3000);
            }
        }

        function selectAI(ai) {
            currentAI = ai;
            
            document.querySelectorAll('.toggle-option').forEach(option => {
                option.classList.remove('active');
            });
            
            if (ai === 'gemini') {
                document.querySelector('.toggle-option.gemini').classList.add('active');
                document.getElementById('aiName').textContent = 'Gemini AI';
            } else {
                document.querySelector('.toggle-option.chatgpt').classList.add('active');
                document.getElementById('aiName').textContent = 'ChatGPT';
            }
            
            const currentAIDiv = document.getElementById('currentAI');
            currentAIDiv.style.display = 'block';
        }

        document.getElementById('chatgptQuestion').addEventListener('input', function() {
            const text = this.value;
            const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            const chars = text.length;
            
            document.getElementById('wordCount').textContent = words;
            document.getElementById('charCount').textContent = chars;
            
            if (words > 300 || chars > 1500) {
                this.style.borderColor = 'red';
            } else if (words > 250 || chars > 1200) {
                this.style.borderColor = 'orange';
            } else {
                this.style.borderColor = '#10A37F';
            }
        });

        async function callAPI(endpoint, data) {
            if (!apiConnected) {
                throw new Error('API routes not deployed. Please check the setup instructions above.');
            }

            try {
                const endpointPath = API_CONFIG.endpoints[endpoint];
                const fullURL = `${API_CONFIG.baseURL}${endpointPath}`;
                
                const response = await fetch(fullURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                // Check for server-side errors (like missing API keys, which return a 500 status from Vercel function)
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}: API endpoint not available or server error.`);
                }

                return await response.json();
            } catch (error) {
                // This catches network errors and the custom errors thrown above
                throw new Error(`API call failed: ${error.message}`);
            }
        }

        async function testWithAI(url, type) {
            const state = document.getElementById('stateSelect').value;
            let stateSpecificInfo = '';
            
            if (state && stateLaws[state]) {
                const stateName = document.getElementById('stateSelect').selectedOptions[0].text;
                const laws = stateLaws[state];
                const lawType = (type === "cookie compliance") ? laws.cookie : laws.accessibility;
                stateSpecificInfo = `\n\nState: ${stateName}\nRelevant Law: ${lawType}`;
            }

            const prompt = `Act as an expert compliance auditor. Analyze the website ${url} for **${type}**. ${stateSpecificInfo}\n\nProvide a detailed analysis in a clear, formatted text response (using markdown). The analysis must include:\n1. Overall compliance score (out of 100)\n2. Key findings and whether the site passes or fails compliance for the selected state/topic.\n3. Specific issues detected (e.g., missing cookie banner, poor color contrast)\n4. Recommendations for immediate improvement (up to 5 points)\n5. State-specific compliance notes if applicable`;

            try {
                // Call the appropriate AI based on the current toggle selection
                const result = await callAPI(currentAI, { prompt });
                return result.response || result.message || 'Analysis completed successfully';
            } catch (error) {
                // Re-throw the error to be caught by the calling event listener function
                throw new Error(`Failed to get AI analysis: ${error.message}`);
            }
        }

        async function askAI() {
            const question = document.getElementById('chatgptQuestion').value.trim();
            if (!question) return alert("Please enter a question!");
            
            const words = question.trim().split(/\s+/).length;
            if (words > 300) return alert("Please keep your question under 300 words!");

            const resultDiv = document.getElementById('chatgptResult');
            resultDiv.innerHTML = `<div class="loading">üí≠ ${currentAI === 'gemini' ? 'Gemini' : 'ChatGPT'} is thinking...</div>`;

            try {
                const result = await callAPI(currentAI, { prompt: question });
                resultDiv.className = "pass chatgpt-response-container expanded";
                resultDiv.innerHTML = `**ü§ñ ${currentAI === 'gemini' ? 'Gemini' : 'ChatGPT'} Response:**\n\n${result.response || result.message}`;
                setTimeout(() => smoothScrollToElement('chatgptResultContainer'), 500);
            } catch (error) {
                resultDiv.className = "fail chatgpt-response-container";
                resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }
        
        // --- Button Event Listeners ---

        document.getElementById("testCookieBtn").addEventListener("click", async () => {
            const url = document.getElementById("websiteInput").value.trim();
            const state = document.getElementById('stateSelect').value;
            if (!url) return alert("Please enter a website URL.");
            if (!state) return alert("Please select a state.");

            const resultDiv = document.getElementById("cookieResult");
            const stateName = document.getElementById('stateSelect').selectedOptions[0].text;
            resultDiv.innerHTML = `<div class="loading">üîÑ Testing Cookie Compliance for **${stateName}** with ${currentAI === 'gemini' ? 'Gemini...' : 'ChatGPT...'}</div>`;

            try {
                const result = await testWithAI(url, "cookie compliance");
                resultDiv.className = "pass";
                resultDiv.innerHTML = result;
                setTimeout(() => smoothScrollToElement('cookieResultContainer'), 500);
            } catch (error) {
                resultDiv.className = "fail";
                resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        });

        document.getElementById("testAccessibilityBtn").addEventListener("click", async () => {
            const url = document.getElementById("websiteInput").value.trim();
            const state = document.getElementById('stateSelect').value;
            if (!url) return alert("Please enter a website URL.");
            if (!state) return alert("Please select a state.");

            const resultDiv = document.getElementById("accessibilityResult");
            const stateName = document.getElementById('stateSelect').selectedOptions[0].text;
            resultDiv.innerHTML = `<div class="loading">üîÑ Testing Accessibility for **${stateName}** with ${currentAI === 'gemini' ? 'Gemini...' : 'ChatGPT...'}</div>`;

            try {
                const result = await testWithAI(url, "accessibility compliance");
                resultDiv.className = "pass";
                resultDiv.innerHTML = result;
                setTimeout(() => smoothScrollToElement('accessibilityResultContainer'), 500);
            } catch (error) {
                resultDiv.className = "fail";
                resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }); 
        
        // --- Report Generation Functions ---

        function generateReport() {
            // Logic for generating and printing a full report
            const websiteUrl = document.getElementById("websiteInput").value;
            const cookieResult = document.getElementById('cookieResultContainer').outerHTML;
            const accessibilityResult = document.getElementById('accessibilityResultContainer').outerHTML;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Compliance Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .results { border: 2px solid #007bff; padding: 20px; margin-bottom: 20px; border-radius: 8px; background: #f8f9fa; }
                        h1, h3 { color: #333; }
                        /* Ensure text content is not pre-wrap for printing */
                        #cookieResult, #accessibilityResult { white-space: normal; } 
                    </style>
                </head>
                <body>
                    <h1>Compliance Report for ${websiteUrl}</h1>
                    ${cookieResult}
                    ${accessibilityResult}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function generateAIReport() {
            // Logic for generating and printing the AI response
            const aiResult = document.getElementById('chatgptResultContainer').outerHTML;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>AI Assistant Response</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        #chatgptResult { border: 2px solid #10A37F; padding: 20px; margin-top: 10px; white-space: pre-wrap; background-color: #f0f9f4; border-radius: 8px; }
                    </style>
                </head>
                <body>
                    <h1>AI Assistant Response</h1>
                    ${aiResult}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // --- Password Logic ---

        let clickCount = 0;
        const secretTarget = document.getElementById('secretTarget');
        const passwordModal = document.getElementById('passwordModal');
        const publicContent = document.getElementById('publicContent');
        const testingPlatform = document.getElementById('testingPlatform');
        // NOTE: Restored your secret password here
        const correctPassword = "333"; 

        secretTarget.addEventListener('click', () => {
            clickCount++;
            if (clickCount >= 7) {
                clickCount = 0; // Reset count
                passwordModal.style.display = 'flex'; // Show modal
            }
        });

        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            const error = document.getElementById('passwordError');

            if (input === correctPassword) {
                passwordModal.style.display = 'none';
                publicContent.style.display = 'none';
                testingPlatform.style.display = 'block';
                error.style.display = 'none';
                // Reset input for next time
                document.getElementById('passwordInput').value = '';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                error.style.display = 'block';
            }
        }

        // Expose functions to global scope for HTML inline handlers
        window.checkPassword = checkPassword;
        window.generateReport = generateReport;
        window.generateAIReport = generateAIReport;
        window.askAI = askAI;
        window.selectAI = selectAI;
    </script>
</body>
</html>
