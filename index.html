<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Testing Platform</title>
    <style>
        #publicContent {
            text-align: center;
            padding: 50px;
            font-family: Arial, sans-serif;
        }
        
        #testingPlatform {
            display: none;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        
        #secretTarget {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            opacity: 0.3;
            background: #ff4444;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10000;
            transition: opacity 0.3s;
            font-size: 18px;
        }
        
        #secretTarget:hover {
            opacity: 0.7;
        }
        
        #passwordModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10001;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            min-width: 300px;
        }
        
        .test-button {
            padding: 12px 24px;
            margin: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .print-button {
            background: #28a745;
        }
        
        .chatgpt-button {
            background: #10A37F;
        }

        .web-chatgpt-button {
            background: #FF6B35;
        }
        
        .results {
            background: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }

        .results.highlight {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .ai-toggle {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .toggle-option {
            padding: 12px 30px;
            margin: 0 10px;
            border: 2px solid #007bff;
            border-radius: 25px;
            cursor: pointer;
            background: white;
            color: #007bff;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .toggle-option.active {
            background: #007bff;
            color: white;
        }

        .toggle-option:hover {
            transform: scale(1.05);
        }

        .toggle-option.gemini.active {
            background: #8B5CF6;
            border-color: #8B5CF6;
        }

        .toggle-option.chatgpt.active {
            background: #10A37F;
            border-color: #10A37F;
        }

        #cookieResult, #accessibilityResult {
            border: 1px solid #ccc;
            padding: 12px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            min-height: 100px;
            line-height: 1.5;
        }

        #chatgptResult {
            border: 1px solid #10A37F;
            padding: 20px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: Arial, sans-serif;
            background-color: #f0f9f4;
            min-height: 150px;
            line-height: 1.6;
            border-radius: 8px;
            resize: vertical;
            overflow: auto;
            max-height: none;
            transition: all 0.3s ease;
        }

        #chatgptResult.expanded {
            min-height: 300px;
            background: #e8f5e8;
        }

        #cookieResult.fail, #accessibilityResult.fail, #chatgptResult.fail {
            border-color: red;
            color: red;
        }

        #cookieResult.pass, #accessibilityResult.pass, #chatgptResult.pass {
            border-color: green;
            color: green;
        }

        .print-report-container {
            border: 3px solid red !important;
            padding: 20px;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
        }

        #websiteInput {
            width: 70%; 
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        #stateSelect {
            width: 200px;
            padding: 12px;
            margin: 10px;
            border: 2px solid #007bff;
            border-radius: 5px;
            font-size: 16px;
            background: white;
        }

        #chatgptQuestion {
            width: 90%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #10A37F;
            border-radius: 8px;
            font-size: 16px;
            font-family: Arial, sans-serif;
            resize: vertical;
            min-height: 120px;
            max-height: 200px;
        }

        .chatgpt-response-container {
            min-height: 200px;
            max-height: none;
            resize: vertical;
            overflow: auto;
        }

        .word-count {
            text-align: right;
            font-size: 12px;
            color: #666;
            margin-top: -5px;
            margin-bottom: 10px;
        }

        .current-ai {
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            background: linear-gradient(45deg, #007bff, #8B5CF6);
            color: white;
            border-radius: 5px;
            display: none;
        }

        .loading {
            color: #007bff;
            font-style: italic;
        }

        .section-title {
            background: linear-gradient(45deg, #10A37F, #8B5CF6);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 25px 0 15px 0;
            text-align: center;
        }

        .state-compliance {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 25px 0 15px 0;
            text-align: center;
        }

        .form-group {
            margin: 15px 0;
            text-align: center;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        html {
            scroll-behavior: smooth;
        }

        .scroll-target {
            scroll-margin-top: 20px;
        }

        .demo-notice {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            color: #155724;
        }

        .api-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .api-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .api-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .api-status.testing {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }
        
        .api-status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Your additional styles for the new functionality */
        .red { color: red; }
        .yellow { color: orange; }
        .green { color: green; }
    </style>
</head>
<body>
    <button id="secretTarget" title="Click me 7 times">üéØ</button>

    <div id="passwordModal">
        <div class="modal-content">
            <h3>üîí Enter Password</h3>
            <input type="password" id="passwordInput" placeholder="Enter password" style="
                padding: 10px;
                margin: 10px 0;
                width: 200px;
                font-size: 16px;
                border: 2px solid #ddd;
                border-radius: 5px;
            ">
            <br>
            <button onclick="checkPassword()" style="
                padding: 10px 20px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 10px;
            ">Login</button>
            <p id="passwordError" style="color: red; display: none; margin-top: 10px;">Incorrect password</p>
        </div>
    </div>

    <div id="publicContent">
        <h1>Welcome to Our Website</h1>
        <p>This is a public website. Nothing to see here for regular visitors.</p>
    </div>

    <div id="testingPlatform">
        <h1>üõ°Ô∏è Your Private Testing Platform</h1>
        <p>Welcome back, my love! Ready to run some tests? üíï</p>
        
        <div class="demo-notice">
            <strong>‚úÖ Live Mode:</strong> Connected to AI services via secure Vercel API endpoints!
        </div>

        <div id="apiStatus" class="api-status testing">
            üîÑ Testing API connection...
        </div>
        
        <div class="state-compliance">
            <h2>üèõÔ∏è State Compliance Testing</h2>
        </div>

        <div class="form-group">
            <label for="stateSelect">Select State for Compliance Analysis:</label>
            <select id="stateSelect">
                <option value="">-- Select a State --</option>
                <option value="california">California</option>
                <option value="newyork">New York</option>
                <option value="florida">Florida</option>
                <option value="texas">Texas</option>
                <option value="georgia">Georgia</option>
                <option value="northcarolina">North Carolina</option>
                <option value="southcarolina">South Carolina</option>
                <option value="utah">Utah</option>
                <option value="virginia">Virginia</option>
                <option value="alabama">Alabama</option>
                <option value="alaska">Alaska</option>
                <option value="arizona">Arizona</option>
                <option value="arkansas">Arkansas</option>
                <option value="colorado">Colorado</option>
                <option value="connecticut">Connecticut</option>
                <option value="delaware">Delaware</option>
                <option value="hawaii">Hawaii</option>
                <option value="idaho">Idaho</option>
                <option value="illinois">Illinois</option>
                <option value="indiana">Indiana</option>
                <option value="iowa">Iowa</option>
                <option value="kansas">Kansas</option>
                <option value="kentucky">Kentucky</option>
                <option value="louisiana">Louisiana</option>
                <option value="maine">Maine</option>
                <option value="maryland">Maryland</option>
                <option value="massachusetts">Massachusetts</option>
                <option value="michigan">Michigan</option>
                <option value="minnesota">Minnesota</option>
                <option value="mississippi">Mississippi</option>
                <option value="missouri">Missouri</option>
                <option value="montana">Montana</option>
                <option value="nebraska">Nebraska</option>
                <option value="nevada">Nevada</option>
                <option value="newhampshire">New Hampshire</option>
                <option value="newjersey">New Jersey</option>
                <option value="newmexico">New Mexico</option>
                <option value="ohio">Ohio</option>
                <option value="oklahoma">Oklahoma</option>
                <option value="oregon">Oregon</option>
                <option value="pennsylvania">Pennsylvania</option>
                <option value="rhodeisland">Rhode Island</option>
                <option value="tennessee">Tennessee</option>
                <option value="vermont">Vermont</option>
                <option value="washington">Washington</option>
                <option value="westvirginia">West Virginia</option>
                <option value="wisconsin">Wisconsin</option>
                <option value="wyoming">Wyoming</option>
            </select>
        </div>
        
        <div class="ai-toggle">
            <div class="toggle-option gemini active" onclick="selectAI('gemini')">
                üîÆ Gemini AI
            </div>
            <div class="toggle-option chatgpt" onclick="selectAI('chatgpt')">
                ü§ñ ChatGPT
            </div>
        </div>

        <div class="current-ai" id="currentAI">
            Currently using: <span id="aiName">Gemini AI</span>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <input type="text" id="websiteInput" placeholder="https://www.example.com" value="https://www.thewebswan.com">
        </div>
        
        <div class="button-group">
            <button class="test-button" id="testCookieBtn">üç™ Test Cookie Compliance</button>
            <button class="test-button" id="testAccessibilityBtn">üîç Test Accessibility</button>
            <button class="test-button" id="advancedTestBtn">üîç Advanced Compliance Test</button>
            <button class="test-button print-button" onclick="generateReport()">üìÑ Generate Report</button>
        </div>
        
        <div class="results scroll-target" id="cookieResultContainer">
            <h3>Cookie Compliance Results</h3>
            <div id="cookieResult">Select a state and run the cookie test to see results here...</div>
        </div>
        
        <div class="results scroll-target" id="accessibilityResultContainer">
            <h3>Accessibility Results</h3>
            <div id="accessibilityResult">Select a state and run the accessibility test to see results here...</div>
        </div>

        <!-- Advanced Test Results Section -->
        <div class="results scroll-target" id="advancedResultContainer" style="display: none;">
            <h3>Advanced Compliance Results</h3>
            <div id="advancedResult">Run advanced test to see detailed results here...</div>
            <pre id="advancedNotes" style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 10px; white-space: pre-wrap;"></pre>
        </div>

        <div class="section-title">
            <h2>üí¨ AI Assistant - Ask Me Anything</h2>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <textarea 
                id="chatgptQuestion" 
                placeholder="Type your question here... (up to 300 words)"
                maxlength="1500"
            ></textarea>
            <div class="word-count">
                <span id="wordCount">0</span>/300 words
                <span id="charCount">0</span>/1500 characters
            </div>
            <div class="button-group">
                <button class="test-button chatgpt-button" onclick="askAI()">
                    üöÄ Ask AI Assistant
                </button>
                <button class="test-button web-chatgpt-button" onclick="window.open('https://chat.openai.com/', '_blank')">
                    üåê Web ChatGPT
                </button>
                <button class="test-button print-button" onclick="generateAIReport()">
                    üìÑ Print Response
                </button>
            </div>
        </div>

        <div class="results scroll-target" id="chatgptResultContainer">
            <h3>AI Assistant Response <small>(Expandable - Up to 1000 words)</small></h3>
            <div id="chatgptResult" class="chatgpt-response-container">Ask a question to see AI response here...</div>
        </div>

        <!-- API Setup Instructions -->
        <div class="results" id="setupInstructions" style="display: none;">
            <h3>üö® API Setup Required</h3>
            <div id="setupContent"></div>
        </div>
    </div>

    <script>
        const stateLaws = {
            california: { 
                cookie: "CCPA/CPRA - California Consumer Privacy Act", 
                accessibility: "Unruh Civil Rights Act + WCAG 2.1 AA" 
            },
            newyork: { 
                cookie: "NY SHIELD Act + Proposed Privacy Law", 
                accessibility: "New York Human Rights Law + WCAG 2.1" 
            },
            florida: { 
                cookie: "Florida Information Protection Act", 
                accessibility: "Florida Civil Rights Act" 
            },
            texas: { 
                cookie: "Texas Identity Theft Enforcement", 
                accessibility: "Texas Human Resources Code" 
            },
            georgia: { 
                cookie: "Georgia Personal Identity Protection", 
                accessibility: "Georgia Equal Access to Services" 
            },
            northcarolina: { 
                cookie: "NC Identity Theft Protection Act", 
                accessibility: "NC Persons with Disabilities Protection" 
            },
            southcarolina: { 
                cookie: "SC Insurance Data Security Act", 
                accessibility: "SC Human Affairs Law" 
            },
            utah: { 
                cookie: "Utah Consumer Privacy Act", 
                accessibility: "Utah Antidiscrimination Act" 
            },
            virginia: { 
                cookie: "VCDPA - Virginia Consumer Data Protection Act", 
                accessibility: "Virginia Human Rights Act" 
            },
            colorado: { cookie: "CPA - Colorado Privacy Act", accessibility: "Colorado Anti-Discrimination Act" },
            connecticut: { cookie: "CTDPA - Connecticut Data Privacy Act", accessibility: "Connecticut Human Rights Law" },
            illinois: { cookie: "BIPA - Biometric Information Privacy Act", accessibility: "Illinois Human Rights Act" },
            nevada: { cookie: "Nevada Privacy Law", accessibility: "Nevada Equal Rights Commission" },
            washington: { cookie: "Washington My Health My Data Act", accessibility: "Washington Law Against Discrimination" }
        };

        // API Configuration
        const API_CONFIG = {
            baseURL: 'https://access-coo-ws.vercel.app',
            endpoints: {
                gemini: '/api/gemini',
                chatgpt: '/api/chatgpt',
                test: '/api/test'
            }
        };

        let currentAI = 'gemini';
        let apiConnected = false;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            checkAPIConnection();
            selectAI('gemini');
            
            // Add your advanced test button event listener
            document.getElementById("advancedTestBtn").addEventListener("click", advancedComplianceTest);
        });

        // Improved API connection test
        async function checkAPIConnection() {
            const statusElement = document.getElementById('apiStatus');
            
            try {
                statusElement.innerHTML = 'üîÑ Testing API connection to Vercel...';
                statusElement.className = 'api-status testing';
                
                // Test multiple endpoints to see what's available
                const endpointsToTest = ['/api/gemini', '/api/chatgpt', '/api/test'];
                let availableEndpoints = [];
                
                for (const endpoint of endpointsToTest) {
                    try {
                        const response = await fetch(`${API_CONFIG.baseURL}${endpoint}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ test: true })
                        });
                        
                        if (response.ok) {
                            availableEndpoints.push(endpoint);
                        }
                    } catch (e) {
                        // Endpoint not available, continue testing others
                    }
                }
                
                if (availableEndpoints.length > 0) {
                    apiConnected = true;
                    statusElement.innerHTML = `‚úÖ API Connected! Available endpoints: ${availableEndpoints.join(', ')}`;
                    statusElement.className = 'api-status connected';
                    document.getElementById('setupInstructions').style.display = 'none';
                } else {
                    // No endpoints found, show setup instructions
                    apiConnected = false;
                    statusElement.innerHTML = '‚ö†Ô∏è API Routes Not Found';
                    statusElement.className = 'api-status warning';
                    showSetupInstructions();
                }
                
            } catch (error) {
                apiConnected = false;
                statusElement.innerHTML = `‚ùå Connection Failed: ${error.message}`;
                statusElement.className = 'api-status error';
                showSetupInstructions();
            }
        }

        // Show setup instructions when APIs are missing
        function showSetupInstructions() {
            const setupDiv = document.getElementById('setupInstructions');
            const setupContent = document.getElementById('setupContent');
            
            setupContent.innerHTML = `
                <p><strong>To fix this, you need to create these API files in your Vercel project:</strong></p>
                
                <h4>1. Create /api/gemini.js:</h4>
                <pre><code>export default async function handler(req, res) {
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  
  if (req.method === 'OPTIONS') return res.status(200).end();
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
  
  try {
    const { prompt } = req.body;
    if (!process.env.GEMINI_API_KEY) throw new Error('GEMINI_API_KEY not configured');
    
    const response = await fetch(\`https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=\${process.env.GEMINI_API_KEY}\`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    
    const data = await response.json();
    const result = data.candidates[0].content.parts[0].text;
    
    res.status(200).json({ response: result, message: 'Success' });
  } catch (error) {
    res.status(500).json({ error: \`Gemini API Error: \${error.message}\` });
  }
}</code></pre>
                
                <h4>2. Create /api/chatgpt.js:</h4>
                <pre><code>export default async function handler(req, res) {
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  
  if (req.method === 'OPTIONS') return res.status(200).end();
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
  
  try {
    const { mainHTML, privacyContent, url } = req.body;

    const prompt = \`
Analyze the website at \${url}.
Main HTML:
\${mainHTML}

Privacy policy content (if available):
\${privacyContent}

Check cookies & privacy:
- If privacy policy exists and contains cookie info and terms, auto-pass.
- Otherwise check cookie banner (Accept/Reject/Opt-out/Opt-in), Do Not Sell, settings, cookie policy, T&C.
Check accessibility:
- alt tags, aria labels, headings, contrast, keyboard navigation

Scoring rules:
- Full compliance = pass (green, 100%)
- Partial = partial (yellow, 65%)
- None = fail (red, 0%)

Return strictly JSON:
{
  "cookies": "pass/partial/fail",
  "accessibility": "pass/partial/fail",
  "score": 0-100,
  "color": "green/yellow/red",
  "notes": "list missing items if any"
}
\`;

    const openaiRes = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": \`Bearer \${process.env.OPENAI_API_KEY}\`
        },
        body: JSON.stringify({
            model: "gpt-4o-mini",
            messages: [{ role: "user", content: prompt }],
            temperature: 0
        })
    });

    const openaiData = await openaiRes.json();
    const content = openaiData.choices[0].message.content;

    const jsonStart = content.indexOf("{");
    const jsonEnd = content.lastIndexOf("}") + 1;
    const parsed = JSON.parse(content.slice(jsonStart, jsonEnd));

    res.status(200).json(parsed);

  } catch (error) {
    console.error("ChatGPT API Error:", error);
    res.status(500).json({ error: "ChatGPT API Error: " + error.message });
  }
}</code></pre>
                
                <h4>3. Set Environment Variables in Vercel:</h4>
                <ul>
                    <li><code>GEMINI_API_KEY</code> = your_actual_gemini_key</li>
                    <li><code>OPENAI_API_KEY</code> = your_actual_openai_key</li>
                </ul>
            `;
            
            setupDiv.style.display = 'block';
        }

        // üíï YOUR ADVANCED COMPLIANCE TEST FUNCTION - Added exactly as you provided
        async function advancedComplianceTest() {
            const url = document.getElementById("websiteInput").value.trim();
            if (!url) {
                alert("Please enter a website URL!");
                return;
            }

            const resultDiv = document.getElementById("advancedResult");
            const notesPre = document.getElementById("advancedNotes");
            const container = document.getElementById("advancedResultContainer");
            
            resultDiv.textContent = "Checking‚Ä¶";
            resultDiv.className = "";
            notesPre.textContent = "";
            container.style.display = 'block';

            try {
                // Fetch main HTML
                const mainRes = await fetch(url);
                const mainHTML = await mainRes.text();

                // Try to find a privacy policy link
                const privacyLinkMatch = mainHTML.match(/href=["'](.*?privacy.*?\.html?)["']/i);
                let privacyContent = "";
                if (privacyLinkMatch && privacyLinkMatch[1]) {
                    let privacyURL = privacyLinkMatch[1];
                    if (!privacyURL.startsWith("http")) {
                        privacyURL = new URL(privacyURL, url).href;
                    }
                    const privacyRes = await fetch(privacyURL);
                    privacyContent = await privacyRes.text();
                }

                // Call Vercel API
                const response = await fetch(`${API_CONFIG.baseURL}/api/chatgpt`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ mainHTML, privacyContent, url })
                });

                const data = await response.json();

                resultDiv.textContent = `Score: ${data.score}%`;
                resultDiv.className = data.color;
                if (data.notes) notesPre.textContent = `Notes: ${data.notes}`;

                // Scroll to results
                setTimeout(() => {
                    smoothScrollToElement('advancedResultContainer');
                }, 500);

            } catch (error) {
                console.error(error);
                resultDiv.textContent = "Error checking compliance!";
                resultDiv.className = "red";
                notesPre.textContent = `Error: ${error.message}`;
            }
        }

        function smoothScrollToElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('highlight');
                element.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center'
                });
                setTimeout(() => {
                    element.classList.remove('highlight');
                }, 3000);
            }
        }

        function selectAI(ai) {
            currentAI = ai;
            
            document.querySelectorAll('.toggle-option').forEach(option => {
                option.classList.remove('active');
            });
            
            if (ai === 'gemini') {
                document.querySelector('.toggle-option.gemini').classList.add('active');
                document.getElementById('aiName').textContent = 'Gemini AI';
            } else {
                document.querySelector('.toggle-option.chatgpt').classList.add('active');
                document.getElementById('aiName').textContent = 'ChatGPT';
            }
            
            const currentAIDiv = document.getElementById('currentAI');
            currentAIDiv.style.display = 'block';
        }

        document.getElementById('chatgptQuestion').addEventListener('input', function() {
            const text = this.value;
            const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            const chars = text.length;
            
            document.getElementById('wordCount').textContent = words;
            document.getElementById('charCount').textContent = chars;
            
            if (words > 300 || chars > 1500) {
                this.style.borderColor = 'red';
            } else if (words > 250 || chars > 1200) {
                this.style.borderColor = 'orange';
            } else {
                this.style.borderColor = '#10A37F';
            }
        });

        async function callAPI(endpoint, data) {
            if (!apiConnected) {
                throw new Error('API routes not deployed. Please check the setup instructions above.');
            }

            try {
                const endpointPath = API_CONFIG.endpoints[endpoint];
                const fullURL = `${API_CONFIG.baseURL}${endpointPath}`;
                
                const response = await fetch(fullURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: API endpoint not available`);
                }

                return await response.json();
            } catch (error) {
                throw new Error(`API call failed: ${error.message}`);
            }
        }

        async function testWithAI(url, type) {
            const state = document.getElementById('stateSelect').value;
            let stateSpecificInfo = '';
            
            if (state && stateLaws[state]) {
                const stateName = document.getElementById('stateSelect').selectedOptions[0].text;
                const laws = stateLaws[state];
                stateSpecificInfo = `\n\nState: ${stateName}\nCookie Law: ${laws.cookie}\nAccessibility Law: ${laws.accessibility}`;
            }

            const prompt = `Analyze the website ${url} for ${type}. ${stateSpecificInfo}\n\nProvide a detailed analysis including:\n1. Overall compliance score (out of 100)\n2. Key findings\n3. Specific issues detected\n4. Recommendations for improvement\n5. State-specific compliance notes if applicable`;

            try {
                const result = await callAPI(currentAI, { prompt, type, url, state });
                return result.response || result.message || 'Analysis completed successfully';
            } catch (error) {
                throw new Error(`Failed to get AI analysis: ${error.message}`);
            }
        }

        async function askAI() {
            const question = document.getElementById('chatgptQuestion').value.trim();
            if (!question) return alert("Please enter a question!");
            
            const words = question.trim().split(/\s+/).length;
            if (words > 300) return alert("Please keep your question under 300 words!");

            const resultDiv = document.getElementById('chatgptResult');
            resultDiv.innerHTML = `<div class="loading">üí≠ ${currentAI === 'gemini' ? 'Gemini' : 'ChatGPT'} is thinking...</div>`;

            try {
                const result = await callAPI(currentAI, { prompt: question, type: 'general', conversational: true });
                resultDiv.className = "pass chatgpt-response-container expanded";
                resultDiv.innerHTML = `<strong>ü§ñ ${currentAI === 'gemini' ? 'Gemini' : 'ChatGPT'} Response:</strong>\n\n${result.response || result.message}`;
                setTimeout(() => smoothScrollToElement('chatgptResultContainer'), 500);
            } catch (error) {
                resultDiv.className = "fail chatgpt-response-container";
                resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        document.getElementById("testCookieBtn").addEventListener("click", async () => {
            const url = document.getElementById("websiteInput").value.trim();
            const state = document.getElementById('stateSelect').value;
            if (!url) return alert("Please enter a website URL.");
            if (!state) return alert("Please select a state.");

            const resultDiv = document.getElementById("cookieResult");
            const stateName = document.getElementById('stateSelect').selectedOptions[0].text;
            resultDiv.innerHTML = `<div class="loading">üîÑ Testing Cookie Compliance for ${stateName} with ${currentAI === 'gemini' ? 'Gemini...' : 'ChatGPT...'}</div>`;

            try {
                const result = await testWithAI(url, "cookie compliance");
                resultDiv.className = "pass";
                resultDiv.innerHTML = result;
                setTimeout(() => smoothScrollToElement('cookieResultContainer'), 500);
            } catch (error) {
                resultDiv.className = "fail";
                resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        });

        document.getElementById("testAccessibilityBtn").addEventListener("click", async () => {
            const url = document.getElementById("websiteInput").value.trim();
            const state = document.getElementById('stateSelect').value;
            if (!url) return alert("Please enter a website URL.");
            if (!state) return alert("Please select a state.");

            const resultDiv = document.getElementById("accessibilityResult");
            const stateName = document.getElementById('stateSelect').selectedOptions[0].text;
            resultDiv.innerHTML = `<div class="loading">üîÑ Testing Accessibility for ${stateName} with ${currentAI === 'gemini' ? 'Gemini...' : 'ChatGPT...'}</div>`;

            try {
                const result = await testWithAI(url, "accessibility");
                resultDiv.className = "pass";
                resultDiv.innerHTML = result;
                setTimeout(() => smoothScrollToElement('accessibilityResultContainer'), 500);
            } catch (error) {
                resultDiv.className = "fail";
                resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        });

        function generateReport() {
            const accessibilityResults = document.getElementById('accessibilityResult').innerHTML;
            const cookieResults = document.getElementById('cookieResult').innerHTML;
            const websiteUrl = document.getElementById('websiteInput').value;
            const stateName = document.getElementById('stateSelect').selectedOptions[0].text;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Website Compliance Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                        .print-report-container { border: 3px solid red !important; padding: 30px; margin: 20px 0; background: white; border-radius: 10px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                        .section { margin-bottom: 40px; }
                        @media print { button { display: none; } body { margin: 20px; } .print-report-container { border: 3px solid red !important; } }
                        .print-controls { text-align: center; margin: 30px 0; padding: 20px; background: #f5f5f5; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìä Website Compliance Report</h1>
                        <p><strong>Website:</strong> ${websiteUrl}</p>
                        <p><strong>State:</strong> ${stateName}</p>
                        <p><strong>AI Used:</strong> ${currentAI === 'gemini' ? 'Gemini AI' : 'ChatGPT'}</p>
                        <p><strong>Generated on:</strong> ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                    </div>
                    
                    <div class="print-report-container">
                        <div class="section">
                            <h2>üîç Accessibility Analysis</h2>
                            ${accessibilityResults}
                        </div>
                        
                        <div class="section">
                            <h2>üç™ Cookie Compliance</h2>
                            ${cookieResults}
                        </div>
                    </div>
                    
                    <div class="print-controls">
                        <button onclick="window.print()" style="padding: 15px 30px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px;">üñ®Ô∏è Print / Save as PDF</button>
                        <button onclick="window.close()" style="padding: 15px 30px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px;">Close Window</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function generateAIReport() {
            const aiResults = document.getElementById('chatgptResult').innerHTML;
            const question = document.getElementById('chatgptQuestion').value;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>AI Assistant Conversation Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                        .print-report-container { border: 3px solid #10A37F !important; padding: 30px; margin: 20px 0; background: white; border-radius: 10px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                        .section { margin-bottom: 40px; }
                        .question { background: #f0f9f4; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                        @media print { button { display: none; } body { margin: 20px; } .print-report-container { border: 3px solid #10A37F !important; } }
                        .print-controls { text-align: center; margin: 30px 0; padding: 20px; background: #f5f5f5; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üí¨ AI Assistant Conversation Report</h1>
                        <p><strong>Generated on:</strong> ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                    </div>
                    
                    <div class="print-report-container">
                        <div class="section">
                            <h2>‚ùì Your Question</h2>
                            <div class="question">${question}</div>
                        </div>
                        
                        <div class="section">
                            <h2>ü§ñ AI Assistant Response</h2>
                            ${aiResults}
                        </div>
                    </div>
                    
                    <div class="print-controls">
                        <button onclick="window.print()" style="padding: 15px 30px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px;">üñ®Ô∏è Print / Save as PDF</button>
                        <button onclick="window.close()" style="padding: 15px 30px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px;">Close Window</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Secret access functionality - WITH CURSOR FIX üíï
        let clickCount = 0;
        const requiredClicks = 7;
        const correctPassword = "333";

        document.getElementById('secretTarget').addEventListener('click', function() {
            clickCount++;
            this.style.opacity = '0.8';
            this.style.transform = 'scale(1.2)';
            setTimeout(() => {
                this.style.opacity = '0.3';
                this.style.transform = 'scale(1)';
            }, 200);
            
            if (clickCount >= requiredClicks) {
                document.getElementById('passwordModal').style.display = 'flex';
                clickCount = 0;
                
                // üíï CURSOR FIX: Focus on password input after modal appears
                setTimeout(() => {
                    document.getElementById('passwordInput').focus();
                }, 100);
            }
        });

        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            const errorElement = document.getElementById('passwordError');
            
            if (input === correctPassword) {
                document.getElementById('passwordModal').style.display = 'none';
                document.getElementById('publicContent').style.display = 'none';
                document.getElementById('testingPlatform').style.display = 'block';
                document.getElementById('secretTarget').style.display = 'none';
                selectAI('gemini');
            } else {
                errorElement.style.display = 'block';
                document.getElementById('passwordInput').value = '';
                
                // üíï CURSOR FIX: Refocus on password input after wrong password
                setTimeout(() => {
                    document.getElementById('passwordInput').focus();
                }, 100);
                
                setTimeout(() => errorElement.style.display = 'none', 3000);
            }
        }

        document.getElementById('passwordModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
                clickCount = 0;
            }
        });

        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') checkPassword();
        });
    </script>
</body>
</html>
